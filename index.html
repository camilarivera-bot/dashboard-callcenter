<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Call Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBIQZr5gmMQojTwGgGgHzymz50pwH93E60",
            authDomain: "supercampeonescallcenter.firebaseapp.com",
            projectId: "supercampeonescallcenter",
            storageBucket: "supercampeonescallcenter.firebasestorage.app",
            messagingSenderId: "560676827898",
            appId: "1:560676827898:web:727d9db1cb8d3bfe738f43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.updateDoc = updateDoc;
        window.doc = doc;

        window.addEventListener('DOMContentLoaded', () => {
            loadRecords();
        });

        async function loadRecords() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                const q = query(collection(db, 'records'), orderBy('date', 'desc'));
                const querySnapshot = await getDocs(q);
                window.records = [];
                querySnapshot.forEach((docSnap) => {
                    window.records.push({ docId: docSnap.id, ...docSnap.data() });
                });
                document.getElementById('loadingSpinner').style.display = 'none';
                updateAgentFilter();
                console.log('Registros cargados:', window.records.length);
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }
        window.loadRecords = loadRecords;

        function updateAgentFilter() {
            const agents = [...new Set(window.records.map(r => r.name))].sort();
            const select = document.getElementById('filterAgent');
            select.innerHTML = '<option value="">Todas las agentes</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                select.appendChild(option);
            });
        }
        window.updateAgentFilter = updateAgentFilter;
    </script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen p-4 md:p-8">
    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-700">Cargando datos...</p>
        </div>
    </div>
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üìä Dashboard Super Campeones</h1>
            <p class="text-gray-600">Sistema de seguimiento y m√©tricas diarias - Firebase Sync</p>
            <div id="saveStatus" class="mt-2"></div>
        </div>
        <div class="flex flex-wrap gap-4 mb-6">
            <button onclick="showView('form')" id="btnForm" class="px-6 py-2 rounded-lg font-semibold bg-purple-600 text-white">üìù Registrar</button>
            <button onclick="showView('dashboard')" id="btnDashboard" class="px-6 py-2 rounded-lg font-semibold bg-white text-gray-700">üìà Estad√≠sticas</button>
            <button onclick="exportToCSV()" class="ml-auto px-6 py-2 rounded-lg font-semibold bg-green-600 text-white">üì• Exportar</button>
        </div>
        <div id="formView" class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Registro Diario</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label><input type="text" id="name" class="w-full px-4 py-2 border rounded-lg" placeholder="Tu nombre"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label><input type="date" id="date" class="w-full px-4 py-2 border rounded-lg"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="border border-purple-200 rounded-lg p-4 bg-purple-50">
                    <h3 class="font-semibold text-purple-900 mb-3">üåô NOCHE</h3>
                    <input type="number" id="nocheTotal" placeholder="Total" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="nocheRespondieron" placeholder="Respondieron" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="nocheVisto" placeholder="Visto" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                    <h3 class="font-semibold text-blue-900 mb-3">‚òÄÔ∏è MA√ëANA</h3>
                    <input type="number" id="mananaTotal" placeholder="Total" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="mananaRespondieron" placeholder="Respondieron" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="mananaVisto" placeholder="Visto" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
                    <h3 class="font-semibold text-orange-900 mb-3">üåÖ TARDE</h3>
                    <input type="number" id="tardeTotal" placeholder="Total" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="tardeRespondieron" placeholder="Respondieron" class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <input type="number" id="tardeVisto" placeholder="Visto" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
            </div>
            <div class="border-t pt-6">
                <h3 class="font-semibold text-gray-800 mb-4">üí∞ Ventas</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs font-medium mb-1">Unidades CT</label><input type="number" id="unidadesCT" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">Total Pares</label><input type="number" id="totalPares" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">M√©todo Cambios</label><input type="number" id="metodoCambios" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">Bodega Alexander</label><input type="number" id="bodegaAlexander" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">Voucher</label><input type="number" id="voucher" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">Anticipado</label><input type="number" id="anticipado" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                    <div><label class="block text-xs font-medium mb-1">Revendedor</label><input type="number" id="revendedor" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="0"></div>
                </div>
            </div>
            <button onclick="submitForm()" id="submitBtn" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-semibold text-lg">‚úÖ Registrar D√≠a</button>
        </div>
        <div id="dashboardView" style="display:none">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">üìÖ Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Mes</label><input type="month" id="selectedMonth" onchange="updateDashboard()" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Agente</label><select id="filterAgent" onchange="updateDashboard()" class="w-full px-4 py-2 border rounded-lg"><option value="">Todas las agentes</option></select></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6"><p class="text-gray-500 text-sm">Total Pares</p><p id="statTotalPares" class="text-3xl font-bold text-purple-600">0</p></div>
                <div class="bg-white rounded-lg shadow-lg p-6"><p class="text-gray-500 text-sm">Mensajes</p><p id="statTotalMensajes" class="text-3xl font-bold text-blue-600">0</p></div>
                <div class="bg-white rounded-lg shadow-lg p-6"><p class="text-gray-500 text-sm">Tasa Respuesta</p><p id="statTasaRespuesta" class="text-3xl font-bold text-green-600">0%</p></div>
                <div class="bg-white rounded-lg shadow-lg p-6"><p class="text-gray-500 text-sm">Agentes</p><p id="statTotalAgentes" class="text-3xl font-bold text-orange-600">0</p></div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">üèÜ Ranking del Mes</h3>
                <div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left text-sm">Pos</th><th class="px-4 py-3 text-left text-sm">Agente</th><th class="px-4 py-3 text-right text-sm">Pares</th><th class="px-4 py-3 text-right text-sm">Unidades CT</th><th class="px-4 py-3 text-right text-sm">Mensajes</th><th class="px-4 py-3 text-right text-sm">Tasa</th><th class="px-4 py-3 text-right text-sm">Promedio</th></tr></thead><tbody id="rankingTable"></tbody></table></div>
            </div>
        </div>
    </div>
    <script>
    window.records=[];
    window.onload=()=>{document.getElementById('date').valueAsDate=new Date();document.getElementById('selectedMonth').value=new Date().toISOString().slice(0,7)};
    function showView(v){document.getElementById('formView').style.display=v==='form'?'block':'none';document.getElementById('dashboardView').style.display=v==='dashboard'?'block':'none';document.getElementById('btnForm').className=v==='form'?'px-6 py-2 rounded-lg font-semibold bg-purple-600 text-white':'px-6 py-2 rounded-lg font-semibold bg-white text-gray-700';document.getElementById('btnDashboard').className=v==='dashboard'?'px-6 py-2 rounded-lg font-semibold bg-purple-600 text-white':'px-6 py-2 rounded-lg font-semibold bg-white text-gray-700';if(v==='dashboard')updateDashboard()}
    async function submitForm(){const n=document.getElementById('name').value.trim();const d=document.getElementById('date').value;if(!n){alert('Ingresa tu nombre');return}document.getElementById('submitBtn').disabled=true;document.getElementById('submitBtn').textContent='‚è≥ Guardando...';const newData={noche:{total:+document.getElementById('nocheTotal').value||0,respondieron:+document.getElementById('nocheRespondieron').value||0,visto:+document.getElementById('nocheVisto').value||0},manana:{total:+document.getElementById('mananaTotal').value||0,respondieron:+document.getElementById('mananaRespondieron').value||0,visto:+document.getElementById('mananaVisto').value||0},tarde:{total:+document.getElementById('tardeTotal').value||0,respondieron:+document.getElementById('tardeRespondieron').value||0,visto:+document.getElementById('tardeVisto').value||0},unidadesCT:+document.getElementById('unidadesCT').value||0,totalPares:+document.getElementById('totalPares').value||0,metodoCambios:+document.getElementById('metodoCambios').value||0,bodegaAlexander:+document.getElementById('bodegaAlexander').value||0,voucher:+document.getElementById('voucher').value||0,anticipado:+document.getElementById('anticipado').value||0,revendedor:+document.getElementById('revendedor').value||0};try{const existing=window.records.find(r=>r.name===n&&r.date===d);if(existing){const updated={noche:{total:existing.noche.total+newData.noche.total,respondieron:existing.noche.respondieron+newData.noche.respondieron,visto:existing.noche.visto+newData.noche.visto},manana:{total:existing.manana.total+newData.manana.total,respondieron:existing.manana.respondieron+newData.manana.respondieron,visto:existing.manana.visto+newData.manana.visto},tarde:{total:existing.tarde.total+newData.tarde.total,respondieron:existing.tarde.respondieron+newData.tarde.respondieron,visto:existing.tarde.visto+newData.tarde.visto},unidadesCT:existing.unidadesCT+newData.unidadesCT,totalPares:existing.totalPares+newData.totalPares,metodoCambios:existing.metodoCambios+newData.metodoCambios,bodegaAlexander:existing.bodegaAlexander+newData.bodegaAlexander,voucher:existing.voucher+newData.voucher,anticipado:existing.anticipado+newData.anticipado,revendedor:existing.revendedor+newData.revendedor};updated.totalMensajes=updated.noche.total+updated.manana.total+updated.tarde.total;updated.totalRespondieron=updated.noche.respondieron+updated.manana.respondieron+updated.tarde.respondieron;await window.updateDoc(window.doc(window.db,'records',existing.docId),updated);document.getElementById('saveStatus').innerHTML='<div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg"><p class="text-sm font-semibold">‚úÖ Datos acumulados en tu registro de hoy</p></div>'}else{const r={name:n,date:d,...newData,timestamp:Date.now()};r.totalMensajes=r.noche.total+r.manana.total+r.tarde.total;r.totalRespondieron=r.noche.respondieron+r.manana.respondieron+r.tarde.respondieron;await window.addDoc(window.collection(window.db,'records'),r);document.getElementById('saveStatus').innerHTML='<div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg"><p class="text-sm font-semibold">‚úÖ Guardado en Firebase</p></div>'}setTimeout(()=>document.getElementById('saveStatus').innerHTML='',3000);['nocheTotal','nocheRespondieron','nocheVisto','mananaTotal','mananaRespondieron','mananaVisto','tardeTotal','tardeRespondieron','tardeVisto','unidadesCT','totalPares','metodoCambios','bodegaAlexander','voucher','anticipado','revendedor'].forEach(id=>document.getElementById(id).value='');document.getElementById('date').valueAsDate=new Date();await window.loadRecords();showView('dashboard')}catch(e){alert('Error: '+e.message);console.error(e)}finally{document.getElementById('submitBtn').disabled=false;document.getElementById('submitBtn').textContent='‚úÖ Registrar D√≠a'}}
    function updateDashboard(){const m=document.getElementById('selectedMonth').value;const agent=document.getElementById('filterAgent').value;const[y,mn]=m.split('-').map(Number);let f=window.records.filter(r=>{const d=new Date(r.date);return d.getMonth()===mn-1&&d.getFullYear()===y});if(agent)f=f.filter(r=>r.name===agent);const a={};f.forEach(r=>{a[r.name]=a[r.name]||{name:r.name,totalPares:0,unidadesCT:0,totalMensajes:0,totalRespondieron:0,days:0};a[r.name].totalPares+=r.totalPares;a[r.name].unidadesCT+=r.unidadesCT;a[r.name].totalMensajes+=r.totalMensajes;a[r.name].totalRespondieron+=r.totalRespondieron;a[r.name].days++});const s=Object.values(a).sort((x,y)=>y.totalPares-x.totalPares),tp=s.reduce((sum,ag)=>sum+ag.totalPares,0),tm=s.reduce((sum,ag)=>sum+ag.totalMensajes,0),tr=s.reduce((sum,ag)=>sum+ag.totalRespondieron,0),t=tm>0?((tr/tm)*100).toFixed(1):0;document.getElementById('statTotalPares').textContent=tp;document.getElementById('statTotalMensajes').textContent=tm;document.getElementById('statTasaRespuesta').textContent=t+'%';document.getElementById('statTotalAgentes').textContent=s.length;const tb=document.getElementById('rankingTable'),c=['bg-yellow-500','bg-gray-400','bg-orange-600','bg-gray-300'];tb.innerHTML=s.length?'':'<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay datos</td></tr>';s.forEach((ag,i)=>{const ta=ag.totalMensajes>0?((ag.totalRespondieron/ag.totalMensajes)*100).toFixed(1):0,p=(ag.totalPares/ag.days).toFixed(1);tb.innerHTML+=`<tr class="border-t hover:bg-gray-50"><td class="px-4 py-3"><span class="${c[i]||'bg-gray-300'} inline-flex w-8 h-8 rounded-full text-white font-bold items-center justify-center">${i+1}</span></td><td class="px-4 py-3 font-medium">${ag.name}</td><td class="px-4 py-3 text-right font-semibold">${ag.totalPares}</td><td class="px-4 py-3 text-right">${ag.unidadesCT}</td><td class="px-4 py-3 text-right">${ag.totalMensajes}</td><td class="px-4 py-3 text-right"><span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">${ta}%</span></td><td class="px-4 py-3 text-right">${p}</td></tr>`})}
    function exportToCSV(){if(!window.records.length){alert('No hay datos');return}let csv='Nombre,Fecha,Noche Total,Noche Respondieron,Noche Visto,Ma√±ana Total,Ma√±ana Respondieron,Ma√±ana Visto,Tarde Total,Tarde Respondieron,Tarde Visto,Unidades CT,Total Pares,M√©todo Cambios,Bodega Alexander,Voucher,Anticipado,Revendedor\n';window.records.forEach(r=>csv+=`${r.name},${r.date},${r.noche.total},${r.noche.respondieron},${r.noche.visto},${r.manana.total},${r.manana.respondieron},${r.manana.visto},${r.tarde.total},${r.tarde.respondieron},${r.tarde.visto},${r.unidadesCT},${r.totalPares},${r.metodoCambios},${r.bodegaAlexander},${r.voucher},${r.anticipado},${r.revendedor}\n`);const b=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`dashboard-${new Date().toISOString().slice(0,10)}.csv`;a.click()}
    </script>
</body>
</html>
